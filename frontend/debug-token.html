<!DOCTYPE html>
<html>
<head>
    <title>Debug JWT Token</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            background: #252526;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        h1 {
            color: #4ec9b0;
            margin-bottom: 20px;
        }
        .token-info {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #4ec9b0;
        }
        .key {
            color: #9cdcfe;
            font-weight: bold;
        }
        .value {
            color: #ce9178;
        }
        .warning {
            background: #332200;
            border-left: 4px solid #ff9900;
            padding: 15px;
            margin: 20px 0;
            color: #ff9900;
        }
        .success {
            background: #003300;
            border-left: 4px solid #4ec9b0;
            padding: 15px;
            margin: 20px 0;
            color: #4ec9b0;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
        }
        button:hover {
            background: #1177bb;
        }
        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            color: #d4d4d4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç JWT Token Debugger</h1>

        <div id="tokenInfo"></div>
        <div id="apiTest"></div>

        <button onclick="testCompaniesAPI()">Test Companies API</button>
        <button onclick="location.reload()">Refresh</button>
    </div>

    <script>
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        // Check localStorage
        const token = localStorage.getItem('token');
        const tokenInfoDiv = document.getElementById('tokenInfo');

        if (!token) {
            tokenInfoDiv.innerHTML = '<div class="warning">‚ùå No token found in localStorage. Please log in.</div>';
        } else {
            const decoded = parseJwt(token);

            if (!decoded) {
                tokenInfoDiv.innerHTML = '<div class="warning">‚ùå Failed to decode token</div>';
            } else {
                let html = '<div class="token-info">';
                html += '<h3>üìã Token Payload:</h3>';
                html += '<pre>' + JSON.stringify(decoded, null, 2) + '</pre>';

                if (decoded.firm_id) {
                    html += '<div class="success">‚úÖ firm_id is present: ' + decoded.firm_id + '</div>';
                } else {
                    html += '<div class="warning">‚ùå firm_id is MISSING from token!<br><br>';
                    html += 'This is why companies are empty. The backend needs firm_id to filter data.<br><br>';
                    html += '<strong>Solution:</strong> The auth service needs to be updated to include firm_id in JWT.</div>';
                }

                html += '</div>';
                tokenInfoDiv.innerHTML = html;
            }
        }

        async function testCompaniesAPI() {
            const apiTestDiv = document.getElementById('apiTest');
            apiTestDiv.innerHTML = '<div class="token-info">Testing API...</div>';

            try {
                const response = await fetch('http://localhost:3000/api/v1/crm/companies', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const data = await response.json();

                let html = '<div class="token-info">';
                html += '<h3>üåê Companies API Response:</h3>';
                html += '<p><span class="key">Status:</span> <span class="value">' + response.status + '</span></p>';
                html += '<p><span class="key">Companies Found:</span> <span class="value">' + (data.data?.length || 0) + '</span></p>';
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                html += '</div>';

                apiTestDiv.innerHTML = html;
            } catch (error) {
                apiTestDiv.innerHTML = '<div class="warning">‚ùå API Error: ' + error.message + '</div>';
            }
        }
    </script>
</body>
</html>
